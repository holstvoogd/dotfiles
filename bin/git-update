#!/bin/bash

usage() {
    echo "usage: git sync [-h] [-u]"
    echo "  -u    include untracked files in stash"
    exit 1
}

INCLUDE_UNTRACKED=0

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) usage ;;
        -u) INCLUDE_UNTRACKED=1 ;;
        *) echo "Unknown parameter: $1"; usage ;;
    esac
    shift
done

CURRENT_BRANCH=$(git branch --show-current)

# Stash changes if any
if [ -n "$(git status --porcelain)" ]; then
    if [ $INCLUDE_UNTRACKED -eq 1 ]; then
        git stash push -u -m "sync_${CURRENT_BRANCH}"
    else
        git stash push -m "sync_${CURRENT_BRANCH}"
    fi
fi

# Update and rebase
git fetch origin
git rebase origin/HEAD

# Restore changes
STASH_INDEX=$(git stash list | grep "sync_${CURRENT_BRANCH}" | cut -d: -f1)
if [ -n "$STASH_INDEX" ]; then
    git stash pop "$STASH_INDEX"
fi
