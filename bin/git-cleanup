#!/bin/bash

REMOTE_BRANCH="staging"

usage() {
    echo "usage: git cleanup [-h] [-b base-branch]"
    echo "  -b <branch>    base branch for checking merges (default: staging)"
    exit 1
}

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -h|--help) usage ;;
        -b) REMOTE_BRANCH="$2"; shift ;;
    esac
    shift
done

# Update remote information
git fetch origin

# Get list of merged branches
MERGED_BRANCHES=$(git branch --merged "origin/${REMOTE_BRANCH}" | grep -v "\*" | grep -v "${REMOTE_BRANCH}" | tr -d ' ')

if [ -z "$MERGED_BRANCHES" ]; then
    echo "No merged branches found"
    exit 0
fi

for branch in $MERGED_BRANCHES; do
    echo "Processing $branch..."
    
    # Clean up stashes for this branch
    git stash list | grep "branch_${branch}" | cut -d: -f1 | xargs -I{} git stash drop {}
    
    # Delete the branch
    git branch -d "$branch"
done

echo "Cleanup complete"
